name: IaC Pipeline

on:
  workflow_dispatch:
    inputs:
      deploy_env:
        description: "Environment to deploy"
        required: true
        default: "dev"

jobs:
  deploy:
    runs-on: self-hosted

    environment:
      name: dev

    concurrency:
      group: deploy-${{ github.ref }}
      cancel-in-progress: true

    permissions:
      id-token: write
      contents: read

    steps:
      # -------------------------
      # Checkout
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # -------------------------
      # Install dependencies
      # -------------------------
      - name: Install dependencies if missing
        run: |
          sudo apt update

          # Terraform
          if ! command -v terraform >/dev/null; then
            sudo apt install -y gnupg software-properties-common curl
            curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp.gpg
            echo "deb [signed-by=/usr/share/keyrings/hashicorp.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" \
              | sudo tee /etc/apt/sources.list.d/hashicorp.list
            sudo apt update && sudo apt install -y terraform
          fi

          # Vagrant
          if ! command -v vagrant >/dev/null; then
            sudo apt install -y vagrant
          fi

          # VirtualBox
          if ! command -v VBoxManage >/dev/null; then
            sudo apt install -y virtualbox
          fi

          # Ansible
          if ! command -v ansible >/dev/null; then
            sudo apt install -y ansible
          fi

          # Docker
          if ! command -v docker >/dev/null; then
            sudo apt install -y docker.io
            sudo systemctl enable --now docker
          fi

          # Containerd
          if ! command -v containerd >/dev/null; then
            sudo apt install -y containerd
            sudo systemctl enable --now containerd
          fi

      # -------------------------
      # Terraform
      # -------------------------
      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

      # -------------------------
      # Vagrant Up
      # -------------------------
      - name: Vagrant Up
        run: |
          cd vagrant
          vagrant up --provider=virtualbox

      # -------------------------
      # Generate dynamic Ansible inventory
      # -------------------------
      - name: Generate dynamic Ansible inventory
        run: |
          cd vagrant
          vagrant ssh-config > ssh-config
          cd ../ansible
          echo "[servers]" > inventory/hosts.ini
          awk '/HostName/ {host=$2} /Port/ {port=$2} /User / {user=$2} END {print "vm ansible_host="host" ansible_port="port" ansible_user="user" ansible_ssh_private_key_file=\"/home/runner/.vagrant.d/insecure_private_key\" ansible_ssh_common_args=\"-o StrictHostKeyChecking=no\""}' ../vagrant/ssh-config >> inventory/hosts.ini

      # -------------------------
      # Run Ansible Playbook
      # -------------------------
      - name: Run Ansible Playbook
        run: |
          cd ansible
          ansible-playbook -i inventory/hosts.ini playbook.yml

      # -------------------------
      # Verify Docker container
      # -------------------------
      - name: Verify Docker container in VM
        run: |
          cd vagrant
          vagrant ssh default -c "docker ps"

      # -------------------------
      # Cleanup
      # -------------------------
      - name: Vagrant Destroy
        if: always()
        run: |
          cd vagrant
          vagrant destroy -f

      - name: Terraform Destroy
        if: always()
        working-directory: terraform
        run: terraform destroy -auto-approve
