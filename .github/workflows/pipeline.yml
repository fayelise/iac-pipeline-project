name: IaC Pipeline

on:
  workflow_dispatch:
    inputs:
      deploy_env:
        description: "Environment to deploy"
        required: true
        default: "production"

jobs:
  deploy:
    runs-on: self-hosted

    environment:
      name: production   #approval gate

    concurrency:
      group: deploy-${{ github.ref }}
      cancel-in-progress: true

    permissions:
      id-token: write     #  required for OIDC
      contents: read

    env:
      VAULT_ADDR: ${{ vars.VAULT_ADDR }}

    steps:
      # -------------------------
      # Checkout
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v3

      # -------------------------
      # Authenticate to Vault using GitHub OIDC
      # -------------------------
      - name: Login to Vault with OIDC
        run: |
          sudo apt install -y jq curl

          JWT=$(curl -s \
            -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sts.amazonaws.com" \
            | jq -r '.value')

          VAULT_TOKEN=$(curl -s \
            --request POST \
            --data "{\"jwt\":\"$JWT\",\"role\":\"github-actions\"}" \
            $VAULT_ADDR/v1/auth/jwt/login \
            | jq -r '.auth.client_token')

          echo "VAULT_TOKEN=$VAULT_TOKEN" >> $GITHUB_ENV

      # -------------------------
      # Read secrets from Vault
      # -------------------------
      - name: Read secrets from Vault
        run: |
          APP_SECRET=$(curl -s \
            -H "X-Vault-Token: $VAULT_TOKEN" \
            $VAULT_ADDR/v1/secret/data/iac/app \
            | jq -r '.data.data.app_secret')

          echo "APP_SECRET=$APP_SECRET" >> $GITHUB_ENV

      # -------------------------
      # Terraform
      # -------------------------
      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform
        run: terraform apply -auto-approve

      # -------------------------
      # Vagrant Up
      # -------------------------
      - name: Vagrant Up
        run: |
          cd vagrant
          vagrant up --provider=virtualbox

      # -------------------------
      # Generate Ansible inventory
      # -------------------------
      - name: Generate Ansible inventory
        run: |
          cd vagrant
          vagrant ssh-config > ssh-config

          cd ../ansible
          echo "[servers]" > inventory/hosts.ini
          echo "default" >> inventory/hosts.ini

      # -------------------------
      # Run Ansible (with Vault secret)
      # -------------------------
      - name: Run Ansible Playbook
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          cd ansible
          ansible-playbook \
            -i inventory/hosts.ini \
            --ssh-common-args='-F ../vagrant/ssh-config' \
            --extra-vars "app_secret=${APP_SECRET}" \
            playbook.yml

      # -------------------------
      # Cleanup
      # -------------------------
      - name: Destroy infrastructure
        if: always()
        run: |
          cd vagrant && vagrant destroy -f
          cd ../terraform && terraform destroy -auto-approve
