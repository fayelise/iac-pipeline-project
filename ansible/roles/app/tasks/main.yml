- name: Copy app files
  copy:
    src: "{{ playbook_dir }}/../app/"
    dest: /opt/app
    owner: root
    group: root
    mode: '0755'

- name: Copy Dockerfile to /opt/app
  copy:
    src: "{{ playbook_dir }}/../app/Dockerfile"  # chemin vers ton Dockerfile local
    dest: /opt/app/Dockerfile
    mode: '0644'

- name: Remove existing container if present
  docker_container:
    name: iac-app
    state: absent
    force_kill: yes

- name: Remove existing image if present
  docker_image:
    name: iac-app
    state: absent
  ignore_errors: yes

- name: Build Docker image
  docker_image:
    name: iac-app
    source: build
    build:
      path: /opt/app
      # dockerfile: Dockerfile   # d√©commente et modifie si le Dockerfile a un autre nom

- name: Run Docker container
  docker_container:
    name: iac-app
    image: iac-app
    state: started
    restart_policy: always
    ports:
      - "5001:5000"

- name: Remove dangling Docker images
  docker_prune:
    images: yes
- name: Copy requirements.txt
  copy:
    src: "{{ playbook_dir }}/../app/requirements.txt"
    dest: /opt/app/requirements.txt
    mode: '0644'

- name: Copy app.py
  copy:
    src: "{{ playbook_dir }}/../app/app.py"
    dest: /opt/app/app.py
    mode: '0644'
